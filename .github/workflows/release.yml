# Automatically builds and publishes the mod when a new release is created on GitHub.
# It uploads the mod to GitHub, CurseForge and Modrinth.

name: Release

on:
  release:
    types: [published]

jobs:
  publish:
    name: Build & Publish
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    #TODO: locally download translations from Crowdin

    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'

    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew

    - name: Build with Gradle
      run: ./gradlew clean build -Pversion=${{ github.event.release.tag_name }}

    - name: Publish mod to GitHub, CurseForge and Modrinth
      id: publish
      uses: Kir-Antipov/mc-publish@v3.2
      with:
        curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
        modrinth-token: ${{ secrets.CURSEFORGE_TOKEN }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

        changelog: ${{ github.event.release.body }}
        java: 17

        modrinth-featured: false

    - name: Read Gradle properties
      id: gradle_properties
      uses: christian-draeger/read-properties@1.1.1
      with:
        path: './gradle.properties'
        properties: 'mod_logo mod_color loader_name loader_icon minecraft_version'


    - name: Read fabric.mod.json properties
      id: fabric_properties
      run: |
        echo "id=$(cat fabric.mod.json | jq -r '.id')" >> $GITHUB_ENV
        echo "name=$(cat fabric.mod.json | jq -r '.name')" >> $GITHUB_ENV

    - name: Send Discord webhook
      uses: Ilshidur/action-discord@0.3.2
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        DISCORD_EMBEDS: |
          ${{ toJSON([
          {
            "color": ${{ steps.gradle_properties.outputs.mod_color }},
            "thumbnail": {
              "url": "${{ steps.gradle_properties.outputs.mod_logo }}"
            },
            "title": "${{ github.event.release.name }} Released",
            "url": "${{ steps.publish.outputs.curseforge-url }}",
            "description": ,
            "fields": [
                {
                  "name": "Download now:",
                  "value": "[<:curseforge:805066577871110196> CurseForge](${{ steps.publish.outputs.curseforge-url }})\n[<:modrinth:805066578215043092> Modrinth](${{ steps.publish.outputs.modrinth-url }})\n[<:github:805066578164580392> GitHub](${{ steps.publish.outputs.github-url }})",
                  "inline": true
                },
            ],
            "footer": {
              "text": "A ${{ steps.gradle_properties.outputs.loader_name }} Mod"
              "icon_url": "${{ steps.gradle_properties.outputs.loader_icon }}"
            }
          }
          ])}}

    - name: Add job summary
      run: |
        echo "### Published mod" >> $GITHUB_STEP_SUMMARY